import vertexai
from vertexai.preview.vision_models import ImageGenerationModel as ImageGen
from vertexai.generative_models import GenerativeModel as VisionModel, Part

# --- ENVIRONMENT CONFIGURATION ---
GCP_PROJECT_ID = "PASTE_ID_HERE"
GCP_REGION = "PASTE_REGION_HERE"
IMAGEN_VERSION = "imagen-4.0-generate-001"
GEMINI_VERSION = "gemini-2.5-flash"
# ---------------------------------

class BouquetProcessor:
    def __init__(self):
        """Initialize the Google Cloud Vertex AI environment."""
        vertexai.init(project=GCP_PROJECT_ID, location=GCP_REGION)
        self.output_filename = "bouquet_snapshot.jpeg"

    def produce_floral_visual(self, description: str) -> str:
        """Triggers the Image Generation model to create a bouquet."""
        engine = ImageGen.from_pretrained(IMAGEN_VERSION)
        
        # Request a single image generation
        collection = engine.generate_images(
            prompt=description,
            number_of_images=1
        )

        collection[0].save(self.output_filename)
        print(f"Success: Visual asset stored at {self.output_filename}")
        return self.output_filename

    def interpret_and_greet(self, local_path: str):
        """Uses computer vision to analyze the image and draft a message."""
        analyzer = VisionModel(GEMINI_VERSION)

        # Load file into memory as binary data
        with open(local_path, "rb") as image_file:
            blob = image_file.read()

        # Prepare multimodal payload
        visual_data = Part.from_data(data=blob, mime_type="image/jpeg")
        instruction = (
            "Examine the floral arrangement in this image. "
            "Compose a brief, thoughtful birthday greeting inspired by these specific flowers."
        )

        # Execute non-streaming inference
        inference = analyzer.generate_content(
            [instruction, visual_data],
            stream=False
        )

        print("\n--- AI-Generated Greeting ---")
        print(inference.text)
        print("-" * 30)

def main():
    # Define the creative brief
    floral_brief = "Create an image containing a bouquet of 2 sunflowers and 3 roses"
    
    # Initialize the worker
    worker = BouquetProcessor()
    
    # Execute Pipeline
    saved_file = worker.produce_floral_visual(floral_brief)
    worker.interpret_and_greet(saved_file)

if __name__ == "__main__":
    main()