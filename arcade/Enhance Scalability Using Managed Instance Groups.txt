#!/bin/bash

# ==========================================
# INFRASTRUCTURE CONFIGURATION
# ==========================================
GCP_REGION="PASTE_REGION_HERE"
PROJECT_ID="PASTE_ID_HERE"  # Optional: Used if switching contexts

# Resource Naming
GROUP_NAME="managed-dev-cluster"
TEMPLATE_NAME="dev-instance-template"

# Scaling Parameters
CAPACITY_INITIAL=1
CAPACITY_MIN=1
CAPACITY_MAX=3
CPU_THRESHOLD=0.6
# ==========================================

echo "Initializing deployment for group: $GROUP_NAME in $GCP_REGION..."

# 1. Provision the Managed Instance Group (MIG)
gcloud compute instance-groups managed create "$GROUP_NAME" \
    --template="$TEMPLATE_NAME" \
    --size="$CAPACITY_INITIAL" \
    --region="$GCP_REGION" \
    --project="$PROJECT_ID"

# 2. Configure the Autoscaling Policy
echo "Applying autoscaling policy (Target: $(echo "$CPU_THRESHOLD * 100" | bc -l)% CPU)..."

gcloud compute instance-groups managed set-autoscaling "$GROUP_NAME" \
    --region="$GCP_REGION" \
    --min-num-replicas="$CAPACITY_MIN" \
    --max-num-replicas="$CAPACITY_MAX" \
    --target-cpu-utilization="$CPU_THRESHOLD" \
    --mode="on" \
    --project="$PROJECT_ID"

echo "Infrastructure setup complete."